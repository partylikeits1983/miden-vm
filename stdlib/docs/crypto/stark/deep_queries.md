
## std::crypto::stark::deep_queries
| Procedure | Description |
| ----------- | ------------- |
| combine_main | Computes a single step of the random linear combination defining the DEEP composition polynomial<br />that is the input to the FRI protocol. More precisely, the sum in question is:<br />$$<br />\sum_{i=0}^k{\alpha_i \cdot \left(\frac{T_i(x) - T_i(z)}{x - z} +<br />\frac{T_i(x) - T_i(z \cdot g)}{x - z \cdot g} \right)}<br />$$<br /><br />and the following instruction computes the denominators $\alpha_i \cdot (T_i(x) - T_i(z))$ and<br />$\alpha_i \cdot (T_i(x) - T_i(z \cdot g))$ and stores the values in two accumulators $r$ and $p$,<br />respectively. This instruction is specialized to main trace columns i.e. the values $T_i(x)$ are<br />base field elements.<br /><br />The stack transition of the instruction can be visualized as follows:<br /><br />+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+---+<br />\|  T7  \|  T6  \|  T5  \|  T4  \|  T3  \|  T2  \|  T1  \|  T0  \|  p1  \|  p0  \|  r1  \|  r0  \|x_addr\|z_addr\|a_addr\| - \|<br />+------+------+------+------+------+------+------+------+------+------+------+------+------+------+------+---+<br /><br />\|\|<br />\/<br /><br />+------+------+------+------+------+------+------+------+------+------+------+------+------+--------+--------+---+<br />\|  T0  \|  T7  \|  T6  \|  T5  \|  T4  \|  T3  \|  T2  \|  T1  \|  p1' \|  p0' \|  r1' \|  r0' \|x_addr\|z_addr+1\|a_addr+1\| - \|<br />+------+------+------+------+------+------+------+------+------+------+------+------+------+--------+--------+---+<br /><br /><br />Here:<br />1- Ti for i in 0..=7 stands for the the value of the i-th trace polynomial for the current query i.e. T_i(x).<br />2- (p0, p1) stands for an extension field element accumulating the values for the quotients with common denominator (x - gz).<br />3- (r0, r1) stands for an extension field element accumulating the values for the quotients with common denominator (x - z).<br />4- x_addr is the memory address from which we are loading the Ti's using the MSTREAM instruction.<br />5- z_addr is the memory address to the i-th OOD evaluation frame at z and gz i.e. T_i(z):= (T_i(z)0, T_i(z)1)<br />and T_i(gz):= (T_i(gz)0, T_i(gz)1)<br />6- a_addr is the memory address of the i-th random element used in batching the trace polynomial quotients.<br />The random elements a := (a0, a1) are stored in memory as [0, 0, a0, a1].<br /><br />Input: [T7, T6, T5, T4, T3, T2, T1, T0, p1, p0, r1, r0, x_addr, z_addr, a_addr, 0]<br />Output: [T0, T7, T6, T5, T4, T3, T2, T1, p1', p0', r1', r0', x_addr, z_addr+1, a_addr+1, 0]<br /> |
| combine_aux | Computes a single step of the random linear combination defining the DEEP composition polynomial<br />that is the input to the FRI protocol. More precisely, the sum in question is:<br />$$<br />\sum_{i=0}^k{\alpha_i \cdot \left(\frac{T_i(x) - T_i(z)}{x - z} +<br />\frac{T_i(x) - T_i(z \cdot g)}{x - z \cdot g} \right)}<br />$$<br /><br />and the following instruction computes the denominators $\alpha_i \cdot (T_i(x) - T_i(z))$ and<br />$\alpha_i \cdot (T_i(x) - T_i(z \cdot g))$ and stores the values in two accumulators $r$ and $p$,<br />respectively. This instruction is specialized to auxiliary trace columns i.e. the values $T_i(x)$<br />are field elements in a quadratic extension field.<br /><br />The stack transition of the instruction can be visualized as follows:<br /><br />+-------+-------+-------+-------+-------+-------+-------+-------+------+------+------+------+------+------+------+---+<br />\|  T31  \|  T30  \|  T21  \|  T20  \|  T11  \|  T10  \|  T01  \|  T00  \|  p1  \|  p0  \|  r1  \|  r0  \|x_addr\|z_addr\|a_addr\| - \|<br />+-------+-------+-------+-------+-------+-------+-------+-------+------+------+------+------+------+------+------+---+<br /><br />\|\|<br />\/<br /><br />+-------+-------+-------+-------+-------+-------+-------+-------+------+------+------+------+------+--------+--------+-----+<br />\|  T31  \|  T30  \|  T21  \|  T20  \|  T11  \|  T10  \|  T01  \|  T00  \|  p1' \|  p0' \|  r1' \|  r0' \|x_addr\|z_addr+1\|a_addr+b\|  -  \|<br />+-------+-------+-------+-------+-------+-------+-------+-------+------+------+------+------+------+--------+--------------+<br /><br /><br />Here:<br />1- Tij for i in 0..=3 and j=0,1 stands for the the value of the j-th coordinate in the quadratic extension field<br />of the i-th auxiliary trace polynomial for the current query i.e. $T_i(x)$.<br />2- (p0, p1) stands for an extension field element accumulating the values for the quotients with common denominator (x - gz).<br />3- (r0, r1) stands for an extension field element accumulating the values for the quotients with common denominator (x - z).<br />4- x_addr is the memory address from which we are loading the Ti's using the MSTREAM instruction.<br />5- z_addr is the memory address to the i-th OOD evaluation frame at z and gz i.e. T_i(z):= (T_i(z)0, T_i(z)1) and T_i(gz):= (T_i(gz)0, T_i(gz)1)<br />6- a_addr is the memory address of the i-th random element used in batching the trace polynomial quotients.<br />The random elements a := (a0, a1) are stored in memory as [0, 0, a0, a1].<br /><br />Input: [T31, T30, T21, T20, T11, T10, T01, T00, p1, p0, r1, r0, x_addr, z_addr, a_addr, 0]<br />Output: [T01, T00, T31, T30, T21, T20, T11, T10, p1', p0', r1', r0', x_addr, z_addr', a_addr', 0]<br /> |
| load_query_row | Loads the next query rows in the main, auxiliary and constraint composition polynomials traces.<br />It takes a pointer to the current random query index and returns that index.<br /><br />Input: [query_ptr, ...]<br />Output: [index, query_ptr, ...]<br /><br />Cycles: 198<br /> |
| compute_denominators | Takes a query index and computes x := offset * domain_gen^index. It also computes the denominators<br />(x - z) and (x - gz).<br /><br />Input: [index, ...]<br />Output: [Z, x, index, ...]  where Z := [-gz1, x -gz0, -z1, x - z0]<br /><br />Cycles: 68<br /> |
| combine_main_trace_columns | Computes the random linear combination involving the main trace columns and accumulates<br />into an accumulator.<br />More specifically, the procedure takes as input a stack in the following configuration:<br />[Y, Y, Acc, P, ...] where:<br /><br />1. P := [CURRENT_TRACE_ROW_PTR, OOD_TRACE_PTR, DEEP_RAND_CC_PTR, 0].<br />2. [Y, Y] is a "garbage" double-word used to mem_stream data referenced by CURRENT_TRACE_ROW_PTR.<br />3. Acc =: [Acc3, Acc2, Acc1, Acc0] is the accumulator holding the current numerator values.<br /><br />The procedure then outputs a stack in the same configuration but with the pointers and accumulators<br />updated to [Y`, Y`, Acc`, P`, ...] where:<br /><br />1. P` := [CURRENT_TRACE_ROW_PTR+18, OOD_TRACE_PTR+72, DEEP_RAND_CC_PTR+72, 0].<br />2. [Y`, Y`] is a "garbage" double-word used to later mem_stream auxiliary portion referenced now<br />by CURRENT_TRACE_ROW_PTR`.<br />3. Acc` is the accumulator holding the updated numerator values i.e. with terms involving main<br />trace columns included.<br /><br />Input: [Y, Y, Acc, P, ...]<br />Output: [Y`, Y`, Acc`, P`, ...]<br /><br />Cycles: 81<br /> |
| combine_aux_trace_columns | Computes the random linear combination involving the aux trace columns and accumulates<br />into an accumulator.<br />More specifically, the procedure takes as input a stack in the following configuration:<br />[Y, Y, Acc, P, ...] where:<br /><br />1. P := [CURRENT_TRACE_ROW_PTR, OOD_TRACE_PTR, DEEP_RAND_CC_PTR, 0].<br />2. [Y, Y] is a "garbage" double-word used to mem_stream data referenced by CURRENT_TRACE_ROW_PTR.<br />3. Acc =: [Acc3, Acc2, Acc1, Acc0] is the accumulator holding the current numerator values.<br /><br />The procedure then outputs a stack in the same configuration but with the pointers and accumulators<br />updated to [Y`, Y`, Acc`, P`, ...] where:<br /><br />1. P` := [CURRENT_TRACE_ROW_PTR+6, OOD_TRACE_PTR+9, DEEP_RAND_CC_PTR+9, 0].<br />2. [Y`, Y`] is a "garbage" double-word used to later mem_stream constraint composition polynomial<br />trace portion referenced now by CURRENT_TRACE_ROW_PTR`.<br />3. Acc` is the accumulator holding the updated numerator values i.e. with terms involving main<br />trace columns included.<br /><br />Input: [Y, Y, Acc, P, ...]<br />Output: [Y`, Y`, Acc`, P`, ...]<br /><br />Cycles: 12<br /> |
| combine_constraint_poly_columns | Computes the random linear combination involving the constraint composition polynomial trace<br />columns and accumulates into an accumulator.<br />More specifically, the procedure takes as input a stack in the following configuration:<br />[Y, Y, Acc, P, ...] where:<br /><br />1. P := [CURRENT_TRACE_ROW_PTR, OOD_TRACE_PTR, DEEP_RAND_CC_PTR, 0].<br />2. [Y, Y] is a "garbage" double-word used to mem_stream data referenced by CURRENT_TRACE_ROW_PTR.<br />3. Acc =: [Acc3, Acc2, Acc1, Acc0] is the accumulator holding the current numerator values.<br /><br />The procedure then outputs the final accumulator value including main and auxiliary trace columns<br />as well as constraint composition polynomial columns.<br />The procedure uses the `combine_aux` by discarding its effect on the second half of the<br />accumulator (i.e. the "gz" part). To do this, we save the value of the accumulator before calling<br />`combine_aux` and then restore the second half of the accumulator after the call.<br /><br />Input: [Y, Y, Acc, P, ...]<br />Output: [Acc`, ...]<br /><br />Cycles: 33<br /> |
| divide_by_denominators_and_sum | Takes the two accumulators holding the numerator values of the two sums and divides them by<br />the denominators and sums them to get the final result.<br />More specifically, the procedure takes as input a stack in the following configuration:<br />[Acc, Z, ...] and computes (a/c) + (b/d) where:<br />1. a is (Acc0, Acc1) as an element in quadratic extension field.<br />2. b is (Acc2, Acc3) as an element in quadratic extension field.<br />3. c is (Z0, Z1) as an element in quadratic extension field.<br />4. d is (Z2, Z3) as an element in quadratic extension field.<br /><br />Input: [Acc, Z, ...]<br />Ouput: [eval1, eval0, ...]<br /><br />Cycles: 38<br /> |
| compute_deep_composition_polynomial_queries | Compute the DEEP composition polynomial FRI queries.<br /><br />Input: [query_ptr, ...]<br />Output: [...]<br />Cycles: 6 + num_queries * 463<br /> |
